<!-- Breadcrumbs -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<!-- Role Suggestion Modal -->
<app-role-suggestion-modal
  [isOpen]="showRoleSuggestionModal()"
  [suggestedRole]="'M√©dico'"
  (dismiss)="onRoleSuggestionDismiss()"
  (roleChanged)="onRoleChanged()"
></app-role-suggestion-modal>

<!-- Header Section -->
<div class="space-y-6">

  <!-- Main Header -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-6 text-white">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="bg-white/20 p-3 rounded-lg">
          <lucide-icon [img]="usersIcon" class="w-8 h-8"></lucide-icon>
        </div>
        <div>
          <h1 class="text-2xl font-bold">Listado de Pacientes</h1>
          <p class="text-blue-100">Directorio completo del padr√≥n de pacientes</p>
        </div>
      </div>
      <div class="flex gap-4">
        <div class="bg-white/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">{{ stats.total }}</div>
          <div class="text-sm text-blue-100">Total pacientes</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 text-center">
          <div class="text-2xl font-bold">{{ stats.active }}</div>
          <div class="text-sm text-blue-100">Pacientes activos</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Features Section -->
  <div class="bg-white rounded-lg p-6 border border-gray-200">
    <div class="flex items-start gap-4">
      <lucide-icon [img]="usersIcon" class="w-6 h-6 text-blue-600 mt-1"></lucide-icon>
      <div class="flex-1">
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Gesti√≥n integral de pacientes</h2>
        <p class="text-gray-600 mb-4">Accede al registro completo de pacientes con informaci√≥n demogr√°fica, historial cl√≠nico, alergias y medicaci√≥n actual para prescripci√≥n segura.</p>
        <ul class="space-y-2 text-sm text-gray-600">
          <li class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-blue-600 rounded-full"></div>
            B√∫squeda r√°pida y avanzada con m√∫ltiples criterios
          </li>
          <li class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-blue-600 rounded-full"></div>
            Alertas de alergias y condiciones cr√≥nicas
          </li>
          <li class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-blue-600 rounded-full"></div>
            Historial completo de prescripciones
          </li>
          <li class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 bg-blue-600 rounded-full"></div>
            Cumplimiento de normativas de privacidad (HIPAA, GDPR)
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
    <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.total }}</div>
          <div class="text-sm text-gray-600">Total</div>
        </div>
        <lucide-icon [img]="usersIcon" class="w-6 h-6 text-blue-500"></lucide-icon>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.active }}</div>
          <div class="text-sm text-gray-600">Activos</div>
        </div>
        <lucide-icon [img]="activityIcon" class="w-6 h-6 text-green-500"></lucide-icon>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border-l-4 border-gray-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.inactive }}</div>
          <div class="text-sm text-gray-600">Inactivos</div>
        </div>
        <lucide-icon [img]="usersIcon" class="w-6 h-6 text-gray-500"></lucide-icon>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.withAllergies }}</div>
          <div class="text-sm text-gray-600">Con alergias</div>
        </div>
        <lucide-icon [img]="alertIcon" class="w-6 h-6 text-red-500"></lucide-icon>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border-l-4 border-orange-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.withConditions }}</div>
          <div class="text-sm text-gray-600">Con condiciones</div>
        </div>
        <lucide-icon [img]="heartIcon" class="w-6 h-6 text-orange-500"></lucide-icon>
      </div>
    </div>
    
    <div class="bg-white rounded-lg p-4 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-gray-900">{{ stats.averageAge }}</div>
          <div class="text-sm text-gray-600">Edad promedio</div>
        </div>
        <lucide-icon [img]="calendarIcon" class="w-6 h-6 text-purple-500"></lucide-icon>
      </div>
    </div>
  </div>

  <!-- Search Tabs -->
  <div class="bg-white rounded-lg shadow">
    <!-- Tab Headers -->
    <div class="border-b border-gray-200">
      <nav class="flex">
        <button
          (click)="switchTab('quick')"
          [class]="activeTab === 'quick' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="flex-1 py-4 px-6 text-center border-b-2 font-medium text-sm transition-colors">
          B√∫squeda R√°pida
        </button>
        <button
          (click)="switchTab('advanced')"
          [class]="activeTab === 'advanced' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
          class="flex-1 py-4 px-6 text-center border-b-2 font-medium text-sm transition-colors">
          B√∫squeda Avanzada
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="p-6">
      <!-- Quick Search Tab -->
      <div *ngIf="activeTab === 'quick'">
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-2">B√∫squeda R√°pida</h3>
          <p class="text-gray-600 text-sm mb-4">Busca pacientes por nombre, identificaci√≥n, tel√©fono o email</p>
          
          <form [formGroup]="quickSearchForm" class="flex gap-4">
            <div class="flex-1 relative">
              <lucide-icon [img]="searchIcon" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></lucide-icon>
              <input
                type="text"
                formControlName="query"
                placeholder="Nombre, identificaci√≥n, tel√©fono o email..."
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button
              type="button"
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
              <lucide-icon [img]="searchIcon" class="w-4 h-4"></lucide-icon>
              Buscar
            </button>
          </form>
        </div>
      </div>

      <!-- Advanced Search Tab -->
      <div *ngIf="activeTab === 'advanced'">
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-900 mb-2">B√∫squeda Avanzada</h3>
          <p class="text-gray-600 text-sm mb-4">Usa m√∫ltiples criterios para encontrar pacientes espec√≠ficos</p>
          
          <form [formGroup]="advancedSearchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Patient Name -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del paciente</label>
              <input
                type="text"
                formControlName="patientName"
                placeholder="Nombre completo"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Identification -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Identificaci√≥n</label>
              <input
                type="text"
                formControlName="identification"
                placeholder="N√∫mero de identificaci√≥n"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Gender -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Sexo</label>
              <select
                formControlName="gender"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>

            <!-- State -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
              <select
                formControlName="state"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos los estados</option>
                <option value="active">Activo</option>
                <option value="inactive">Inactivo</option>
              </select>
            </div>

            <!-- Age From -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Edad desde</label>
              <input
                type="number"
                formControlName="ageFrom"
                placeholder="0"
                min="0"
                max="150"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Age To -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Edad hasta</label>
              <input
                type="number"
                formControlName="ageTo"
                placeholder="120"
                min="0"
                max="150"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Allergies -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Alergias</label>
              <select
                formControlName="allergies"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos</option>
                <option value="Con alergias">Con alergias</option>
                <option value="Sin alergias">Sin alergias</option>
              </select>
            </div>

            <!-- Chronic Conditions -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Condiciones cr√≥nicas</label>
              <select
                formControlName="chronicConditions"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Todos</option>
                <option value="Con condiciones">Con condiciones</option>
                <option value="Sin condiciones">Sin condiciones</option>
              </select>
            </div>
          </form>

          <div class="flex gap-4 mt-6">
            <button
              type="button"
              (click)="performAdvancedSearch()"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
              <lucide-icon [img]="filterIcon" class="w-4 h-4"></lucide-icon>
              Buscar con filtros
            </button>
            <button
              type="button"
              (click)="clearAdvancedFilters()"
              class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
              <lucide-icon [img]="xIcon" class="w-4 h-4"></lucide-icon>
              Limpiar filtros
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="bg-white rounded-lg shadow" (click)="cerrarModalAcciones()">
    <!-- Results Header -->
    <div class="p-6 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Pacientes registrados</h3>
          <p class="text-sm text-gray-600">{{ filteredPatients.length }} paciente(s) ‚Ä¢ Doble clic para ver detalles</p>
        </div>
        <div class="flex gap-3">
          <div class="relative">
            <button
              (click)="exportPatients(); $event.stopPropagation()"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
              <lucide-icon [img]="downloadIcon" class="w-4 h-4"></lucide-icon>
              Exportar
            </button>
            
            <!-- Dropdown de exportar -->
            <div 
              *ngIf="showExportModal"
              (click)="$event.stopPropagation()"
              class="absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
            >
              <div class="p-4">
                <h4 class="text-sm font-medium text-gray-900 mb-3">Exportar datos a:</h4>
                <div class="space-y-2">
                  <button 
                    (click)="exportToPDF(); $event.stopPropagation()"
                    class="w-full flex items-center gap-3 p-2 text-left rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <div class="w-6 h-6 bg-red-100 rounded flex items-center justify-center">
                      <lucide-icon [img]="fileTextIcon" class="w-3 h-3 text-red-600"></lucide-icon>
                    </div>
                    <span class="text-sm font-medium text-gray-900">PDF</span>
                  </button>
                  
                  <button 
                    (click)="exportToCSV(); $event.stopPropagation()"
                    class="w-full flex items-center gap-3 p-2 text-left rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <div class="w-6 h-6 bg-green-100 rounded flex items-center justify-center">
                      <lucide-icon [img]="fileTextIcon" class="w-3 h-3 text-green-600"></lucide-icon>
                    </div>
                    <span class="text-sm font-medium text-gray-900">CSV</span>
                  </button>
                  
                  <button 
                    (click)="exportToExcel(); $event.stopPropagation()"
                    class="w-full flex items-center gap-3 p-2 text-left rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <div class="w-6 h-6 bg-blue-100 rounded flex items-center justify-center">
                      <lucide-icon [img]="fileTextIcon" class="w-3 h-3 text-blue-600"></lucide-icon>
                    </div>
                    <span class="text-sm font-medium text-gray-900">Excel</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button
            (click)="createNewPatient(); $event.stopPropagation()"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
            <lucide-icon [img]="userPlusIcon" class="w-4 h-4"></lucide-icon>
            Nuevo paciente
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="p-8 text-center">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
      <p class="text-gray-600 mt-2">Cargando pacientes...</p>
    </div>

    <!-- Table -->
    <div *ngIf="!loading" class="overflow-x-auto" style="max-height: 500px; overflow-y: auto;">
      <table class="w-full min-w-[1200px]">
        <thead class="bg-gray-50 sticky top-0">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paciente</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Identificaci√≥n</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Edad/Sexo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alertas</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recetas</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let patient of paginatedPatients" 
              class="hover:bg-blue-50/50 cursor-pointer"
              (dblclick)="viewPatient(patient)">
            <!-- Patient Info -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                    <lucide-icon [img]="usersIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{ patient.fullName }}</div>
                  <div class="text-sm text-gray-500">{{ patient.city || 'Sin ciudad' }}</div>
                </div>
              </div>
            </td>

            <!-- Identification -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ patient.idType }} {{ patient.idNumber }}</div>
              <div class="text-sm text-gray-500">{{ patient.bloodType || 'N/A' }}</div>
            </td>

            <!-- Contact -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 flex items-center gap-1">
                <lucide-icon [img]="phoneIcon" class="w-3 h-3 text-gray-400"></lucide-icon>
                {{ patient.phone }}
              </div>
              <div class="text-sm text-gray-500 flex items-center gap-1" *ngIf="patient.email">
                <lucide-icon [img]="mailIcon" class="w-3 h-3 text-gray-400"></lucide-icon>
                {{ patient.email }}
              </div>
            </td>

            <!-- Age/Gender -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ patient.age }} a√±os</div>
              <div class="text-sm text-gray-500">{{ getGenderLabel(patient.gender) }}</div>
            </td>

            <!-- Alerts -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-col gap-1">
                <span *ngIf="patient.allergies.length > 0" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  <lucide-icon [img]="alertIcon" class="w-3 h-3 mr-1"></lucide-icon>
                  {{ patient.allergies.length }} alergia(s)
                </span>
                <span *ngIf="patient.chronicConditions.length > 0" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                  <lucide-icon [img]="heartIcon" class="w-3 h-3 mr-1"></lucide-icon>
                  {{ patient.chronicConditions.length }} condici√≥n(es)
                </span>
              </div>
            </td>

            <!-- Prescriptions -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ getPrescriptionCount(patient.id) }}</div>
              <div class="text-sm text-gray-500">{{ patient.currentMedications.length }} activa(s)</div>
            </td>

            <!-- Status -->
            <td class="px-6 py-4 whitespace-nowrap">
              <span [class]="'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ' + getStatusClass(patient.status)">
                {{ getStatusLabel(patient.status) }}
              </span>
            </td>

            <!-- Actions -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="relative">
                <button 
                  (click)="toggleAccionesModal(patient.id); $event.stopPropagation()"
                  class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors"
                >
                  <lucide-icon [img]="moreVerticalIcon" class="w-5 h-5"></lucide-icon>
                </button>
                
                <!-- Modal de acciones -->
                <div 
                  *ngIf="modalAccionesAbierto === patient.id"
                  (click)="$event.stopPropagation()"
                  class="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
                >
                  <div class="py-2">
                    <div class="px-4 py-2 text-sm font-medium text-gray-700 border-b border-gray-100">
                      Acciones
                    </div>
                    
                    <button 
                      (click)="viewPatient(patient); cerrarModalAcciones(); $event.stopPropagation()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="eyeIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Ver detalles
                    </button>
                    
                    <button 
                      (click)="editPatient(patient); cerrarModalAcciones()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="editIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Editar paciente
                    </button>
                    
                    <button 
                      (click)="exportPatients(); cerrarModalAcciones()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="downloadIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Exportar datos
                    </button>
                    
                    <button 
                      (click)="createNewPatient(); cerrarModalAcciones(); $event.stopPropagation()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="fileTextIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Ver historial
                    </button>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div *ngIf="filteredPatients.length === 0" class="p-8 text-center">
        <lucide-icon [img]="usersIcon" class="w-12 h-12 text-gray-400 mx-auto mb-4"></lucide-icon>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron pacientes</h3>
        <p class="text-gray-600">Intenta ajustar los criterios de b√∫squeda o crear un nuevo paciente.</p>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && filteredPatients.length > 0" class="px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-700">
          Mostrando {{ (currentPage - 1) * pageSize + 1 }} a {{ Math.min(currentPage * pageSize, filteredPatients.length) }} de {{ filteredPatients.length }} pacientes
        </div>
        <div class="flex items-center space-x-2">
          <button 
            (click)="goToPage(currentPage - 1)"
            [disabled]="currentPage === 1"
            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
            <lucide-icon [img]="chevronLeftIcon" class="w-4 h-4"></lucide-icon>
            Anterior
          </button>
          
          <div class="flex space-x-1">
            <button 
              *ngFor="let page of pageNumbers"
              (click)="goToPage(page)"
              [class]="page === currentPage 
                ? 'px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md'
                : 'px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50'">
              {{ page }}
            </button>
          </div>
          
          <button 
            (click)="goToPage(currentPage + 1)"
            [disabled]="currentPage === totalPages"
            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
            Siguiente
            <lucide-icon [img]="chevronRightIcon" class="w-4 h-4"></lucide-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal lateral derecho para detalles de paciente -->
<div 
  *ngIf="showPatientModal && selectedPatient"
  class="fixed inset-0 z-50 overflow-hidden"
  (click)="closePatientModal()"
>
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black bg-opacity-50"></div>
  
  <!-- Panel lateral -->
  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col"
       (click)="$event.stopPropagation()">
    
    <!-- Header del modal -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-white flex-shrink-0">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-2">
            <lucide-icon [img]="usersIcon" class="w-5 h-5"></lucide-icon>
            <h2 class="text-lg font-semibold">Vista R√°pida del Paciente</h2>
          </div>
          <p class="text-blue-100 text-sm mt-1">{{ selectedPatient.idType }} {{ selectedPatient.idNumber }}</p>
        </div>
        <button 
          (click)="closePatientModal()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors"
        >
          <lucide-icon [img]="xIcon" class="w-5 h-5"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- Contenido del modal con scroll -->
    <div class="flex-1 overflow-y-auto">
      <div class="p-6 space-y-6">
      <!-- Patient Basic Info -->
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-center gap-4 mb-4">
          <div class="bg-blue-100 p-3 rounded-full">
            <lucide-icon [img]="usersIcon" class="w-6 h-6 text-blue-600"></lucide-icon>
          </div>
          <div class="flex-1">
            <h3 class="text-xl font-semibold text-gray-900">{{ selectedPatient.fullName }}</h3>
            <p class="text-gray-600">{{ selectedPatient.idType }} {{ selectedPatient.idNumber }}</p>
            <span [class]="'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mt-2 ' + getStatusClass(selectedPatient.status)">
              {{ getStatusLabel(selectedPatient.status) }}
            </span>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="text-gray-600">Edad:</span>
            <span class="ml-2 font-medium">{{ selectedPatient.age }} a√±os</span>
          </div>
          <div>
            <span class="text-gray-600">Sexo:</span>
            <span class="ml-2 font-medium">{{ getGenderLabel(selectedPatient.gender) }}</span>
          </div>
          <div>
            <span class="text-gray-600">Fecha de nacimiento:</span>
            <span class="ml-2 font-medium">{{ selectedPatient.birthDate | date:'dd/MM/yyyy' }}</span>
          </div>
          <div>
            <span class="text-gray-600">Tipo de sangre:</span>
            <span class="ml-2 font-medium">{{ selectedPatient.bloodType || 'N/A' }}</span>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div>
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="phoneIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
          Informaci√≥n de Contacto
        </h4>
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <lucide-icon [img]="phoneIcon" class="w-4 h-4 text-gray-400"></lucide-icon>
            <span class="text-gray-600">Tel√©fono:</span>
            <span class="font-medium">{{ selectedPatient.phone }}</span>
          </div>
          <div class="flex items-center gap-3" *ngIf="selectedPatient.email">
            <lucide-icon [img]="mailIcon" class="w-4 h-4 text-gray-400"></lucide-icon>
            <span class="text-gray-600">Email:</span>
            <span class="font-medium">{{ selectedPatient.email }}</span>
          </div>
          <div class="flex items-start gap-3" *ngIf="selectedPatient.address">
            <lucide-icon [img]="mapPinIcon" class="w-4 h-4 text-gray-400 mt-0.5"></lucide-icon>
            <div>
              <span class="text-gray-600">Direcci√≥n:</span>
              <div class="font-medium">{{ selectedPatient.address }}</div>
              <div class="text-sm text-gray-500">{{ selectedPatient.city }}, {{ selectedPatient.country }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical Information -->
      <div *ngIf="selectedPatient.insuranceProvider">
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="stethoscopeIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
          Seguro M√©dico
        </h4>
        <div class="bg-blue-50 rounded-lg p-4">
          <div class="text-sm">
            <div class="font-medium">{{ selectedPatient.insuranceProvider }}</div>
            <div class="text-gray-600">P√≥liza: {{ selectedPatient.insuranceNumber || 'N/A' }}</div>
          </div>
        </div>
      </div>

      <!-- Allergies -->
      <div *ngIf="selectedPatient.allergies.length > 0">
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="alertIcon" class="w-5 h-5 text-red-600"></lucide-icon>
          Alergias Conocidas
        </h4>
        <div class="bg-red-50 rounded-lg p-4">
          <div class="flex flex-wrap gap-2">
            <span *ngFor="let allergy of selectedPatient.allergies" 
                  class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
              <span class="w-2 h-2 bg-red-600 rounded-full mr-2"></span>
              {{ allergy }}
            </span>
          </div>
        </div>
      </div>

      <!-- Chronic Conditions -->
      <div *ngIf="selectedPatient.chronicConditions.length > 0">
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="heartIcon" class="w-5 h-5 text-orange-600"></lucide-icon>
          Condiciones Cr√≥nicas
        </h4>
        <div class="bg-orange-50 rounded-lg p-4">
          <div class="flex flex-wrap gap-2">
            <span *ngFor="let condition of selectedPatient.chronicConditions" 
                  class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
              <lucide-icon [img]="heartIcon" class="w-3 h-3 mr-2"></lucide-icon>
              {{ condition }}
            </span>
          </div>
        </div>
      </div>

      <!-- Current Medications -->
      <div *ngIf="selectedPatient.currentMedications.length > 0">
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="pillIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
          Medicaci√≥n Actual
        </h4>
        <div class="bg-blue-50 rounded-lg p-4">
          <div class="space-y-2">
            <div *ngFor="let medication of selectedPatient.currentMedications" 
                 class="flex items-center gap-3 p-2 bg-white rounded border">
              <lucide-icon [img]="pillIcon" class="w-4 h-4 text-blue-600"></lucide-icon>
              <span class="font-medium text-blue-900">{{ medication }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Prescription History -->
      <div>
        <h4 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
          <lucide-icon [img]="fileTextIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
          Historial de Prescripciones
        </h4>
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-blue-900">{{ getPrescriptionCount(selectedPatient.id) }}</div>
            <div class="text-sm text-blue-600">Total recetas</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-2xl font-bold text-green-900">{{ selectedPatient.currentMedications.length }}</div>
            <div class="text-sm text-green-600">Recetas activas</div>
          </div>
        </div>
        
        <div class="mt-4 space-y-2 text-sm">
          <div class="flex items-center gap-2">
            <lucide-icon [img]="calendarIcon" class="w-4 h-4 text-gray-400"></lucide-icon>
            <span class="text-gray-600">√öltima visita:</span>
            <span class="font-medium">{{ selectedPatient.lastVisit | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="flex items-center gap-2">
            <lucide-icon [img]="calendarIcon" class="w-4 h-4 text-gray-400"></lucide-icon>
            <span class="text-gray-600">Registrado desde:</span>
            <span class="font-medium">{{ selectedPatient.registrationDate | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer con botones de acci√≥n -->
    <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex-shrink-0">
      <div class="space-y-3">
        <button
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
          <lucide-icon [img]="eyeIcon" class="w-4 h-4"></lucide-icon>
          Ver perfil completo
        </button>
        <button
          class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
          <lucide-icon [img]="fileTextIcon" class="w-4 h-4"></lucide-icon>
          Ver recetas
        </button>
        <button
          (click)="editPatient(selectedPatient!)"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
          <lucide-icon [img]="editIcon" class="w-4 h-4"></lucide-icon>
          Editar paciente
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Nuevo Paciente - FORZADO A APARECER -->
<div *ngIf="showNewPatientModal" 
     style="position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important; 
            background-color: rgba(255, 0, 0, 0.9) !important; 
            z-index: 999999 !important; 
            display: flex !important; 
            align-items: center !important; 
            justify-content: center !important;">
  <div style="background-color: yellow !important; 
              border: 10px solid black !important; 
              padding: 50px !important; 
              border-radius: 20px !important; 
              max-width: 600px !important; 
              width: 90% !important;">
    <h1 style="font-size: 48px !important; 
               font-weight: bold !important; 
               text-align: center !important; 
               margin-bottom: 20px !important; 
               color: black !important;">
      üéâ MODAL FUNCIONANDO üéâ
    </h1>
    <p style="font-size: 24px !important; 
              text-align: center !important; 
              margin-bottom: 30px !important; 
              color: black !important;">
      Estado: {{ showNewPatientModal }}
    </p>
    <div style="text-align: center !important;">
      <button (click)="closeNewPatientModal()" 
              style="padding: 20px 40px !important; 
                     background-color: red !important; 
                     color: white !important; 
                     font-size: 24px !important; 
                     border: none !important; 
                     border-radius: 10px !important; 
                     cursor: pointer !important;">
        CERRAR MODAL
      </button>
    </div>
  </div>
</div>

<!-- Modal de nuevo paciente usando el componente Angular -->
<app-new-patient-dialog
  [open]="showNewPatientModal"
  (openChange)="onNewPatientModalChange($event)"
  (patientCreated)="onPatientCreated($event)"
></app-new-patient-dialog>