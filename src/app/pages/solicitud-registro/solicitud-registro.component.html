<div class="min-h-screen relative overflow-hidden">
  <!-- Fondo con gradiente médico profesional -->
  <div class="absolute inset-0 bg-gradient-to-br from-blue-50 via-white to-cyan-50"></div>
  
  <!-- Patrón de grid médico sutil -->
  <div class="absolute inset-0 bg-grid-pattern opacity-40"></div>
  
  <!-- Círculos decorativos médicos -->
  <div class="absolute top-0 right-0 w-96 h-96 bg-blue-400/10 rounded-full blur-3xl"></div>
  <div class="absolute bottom-0 left-0 w-96 h-96 bg-cyan-400/10 rounded-full blur-3xl"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-gradient-to-br from-blue-300/5 to-cyan-300/5 rounded-full blur-3xl"></div>

  <!-- Contenedor principal con dos columnas -->
  <div class="relative min-h-screen flex">
    <!-- Columna izquierda: Branding e información - 40% en lg, 35% en xl -->
    <div class="hidden lg:flex lg:w-2/5 xl:w-[35%] bg-gradient-to-br from-blue-600 via-blue-700 to-cyan-700 relative overflow-hidden">
      <!-- Imagen de fondo con overlay -->
      <div class="absolute inset-0 opacity-20">
        <img src="https://images.unsplash.com/photo-1753487050407-8e92c66d9af4?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&q=80&w=1080" 
             alt="Medical Registration" class="w-full h-full object-cover" />
      </div>
      
      <!-- Overlay oscuro para legibilidad -->
      <div class="absolute inset-0 bg-gradient-to-br from-blue-900/40 via-blue-800/50 to-cyan-900/40"></div>
      
      <!-- Patrón de cruz médica sutil -->
      <div class="absolute inset-0 opacity-10 bg-medical-cross"></div>

      <!-- Contenido -->
      <div class="relative z-10 flex flex-col justify-between p-8 xl:p-12 text-white">
        <!-- Header con logo -->
        <div>
          <div class="flex items-center gap-3 mb-8">
            <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center ring-2 ring-white/30">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-white text-2xl">ePrescription</h1>
              <p class="text-blue-100 text-sm">Registro de Usuario</p>
            </div>
          </div>

          <div class="space-y-6 max-w-md">
            <div>
              <h2 class="text-3xl xl:text-4xl mb-3 leading-tight" [innerHTML]="getSidebarTitle()"></h2>
              <p class="text-blue-100 text-base leading-relaxed" [innerHTML]="getSidebarDescription()"></p>
            </div>

            <!-- Características destacadas según el paso -->
            <div class="space-y-3">
              <div *ngFor="let feature of getSidebarFeatures()" class="flex items-start gap-2.5 group">
                <div class="w-9 h-9 bg-white/10 backdrop-blur-sm rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-white/20 transition-colors">
                  <span class="text-sm">{{ feature.icon }}</span>
                </div>
                <div>
                  <h3 class="font-medium text-sm mb-0.5">{{ feature.title }}</h3>
                  <p class="text-xs text-blue-100">{{ feature.description }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer con badges -->
        <div class="space-y-4">
          <div class="flex flex-wrap gap-2">
            <span class="bg-white/10 border border-white/20 text-white backdrop-blur-sm px-2 py-1 rounded text-xs">HL7 Compatible</span>
            <span class="bg-white/10 border border-white/20 text-white backdrop-blur-sm px-2 py-1 rounded text-xs">FHIR R4</span>
            <span class="bg-white/10 border border-white/20 text-white backdrop-blur-sm px-2 py-1 rounded text-xs">HIPAA Compliant</span>
            <span class="bg-white/10 border border-white/20 text-white backdrop-blur-sm px-2 py-1 rounded text-xs">FDA Certified</span>
          </div>
          <p class="text-xs text-blue-200">
            © 2025 ePrescription. Sistema certificado bajo normativas internacionales.
          </p>
        </div>
      </div>
    </div>

    <!-- Columna derecha: Formulario de registro - 60% en lg, 65% en xl -->
    <div class="flex-1 lg:w-3/5 xl:w-[65%] flex flex-col p-6 sm:p-8 lg:p-10 xl:p-12 overflow-y-auto">
      <div class="w-full max-w-3xl mx-auto my-auto">
        <!-- Logo móvil -->
        <div class="lg:hidden text-center mb-6">
          <div class="inline-flex items-center justify-center w-14 h-14 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-xl mb-3 shadow-lg">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <h1 class="text-primary mb-1 text-xl">Solicitud de registro</h1>
          <p class="text-muted-foreground text-sm">
            {{ getCurrentStepSubtitle() }}
          </p>
        </div>

        <!-- Progress indicator - Compacto y eficiente -->
        <div class="mb-8 animate-in fade-in slide-in-from-top-2 duration-500">
          <div class="flex items-center justify-between max-w-2xl mx-auto relative">
            <div *ngFor="let step of steps; let i = index" class="flex items-center flex-1 relative">
              <div class="relative flex flex-col items-center z-10 transition-all duration-300"
                   [ngClass]="{ 'scale-100': i <= currentStep, 'scale-95': i > currentStep }">
                <div class="flex items-center justify-center w-10 h-10 rounded-full border-2 transition-all duration-300"
                     [ngClass]="{
                       'bg-gradient-to-br from-blue-600 to-cyan-600 border-blue-500 text-white': i <= currentStep,
                       'bg-white border-gray-300 text-gray-500': i > currentStep
                     }">
                  <span *ngIf="i < currentStep" class="text-sm">✓</span>
                  <span *ngIf="i >= currentStep" class="text-sm font-medium">{{ i + 1 }}</span>
                </div>
                <!-- Mini label debajo -->
                <span class="absolute -bottom-5 text-xs whitespace-nowrap transition-all duration-300"
                      [ngClass]="{
                        'text-primary font-medium': i <= currentStep,
                        'text-muted-foreground': i > currentStep
                      }">
                  Paso {{ i + 1 }}
                </span>
              </div>
              <div *ngIf="i < steps.length - 1" class="flex-1 h-1.5 mx-2 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full transition-all duration-500 ease-out rounded-full"
                     [ngClass]="{
                       'w-full bg-gradient-to-r from-blue-600 to-cyan-600': i < currentStep,
                       'w-0 bg-gray-300': i >= currentStep
                     }"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="shadow-lg bg-white rounded-lg">
          <div class="space-y-2 pb-4 p-6">
            <h2 class="text-xl font-semibold">
              {{ getCurrentStepTitle() }}
            </h2>
            <p class="text-sm text-gray-600">
              {{ getCurrentStepDescription() }}
            </p>
          </div>
        
          <div class="pt-0 p-6">
            <!-- Mensajes de error/éxito -->
            <div *ngIf="errorMessage" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg animate-in fade-in slide-in-from-top-2">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="h-4 w-4 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="text-red-800">{{ errorMessage }}</span>
                </div>
                <button type="button" (click)="clearMessages()" class="text-red-600 hover:text-red-800 ml-2">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div *ngIf="successMessage" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg animate-in fade-in slide-in-from-top-2">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <svg class="h-4 w-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span class="text-green-800">{{ successMessage }}</span>
                </div>
                <button type="button" (click)="clearMessages()" class="text-green-600 hover:text-green-800 ml-2">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            <!-- PASO 1: Perfil y medicamentos controlados -->
            <div *ngIf="currentStep === 0" class="space-y-5 animate-in fade-in slide-in-from-right-4 duration-500">
              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Tipo de perfil de usuario
                </label>
                <select [(ngModel)]="formData.perfilUsuario" 
                        class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <option value="">Seleccione su perfil...</option>
                  <option *ngFor="let perfil of PERFILES_USUARIO" [value]="perfil.value">
                    {{ perfil.label }}
                  </option>
                </select>
                <div *ngIf="formData.perfilUsuario" class="p-3 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg animate-in fade-in slide-in-from-top-2">
                  <p class="text-sm text-blue-900">
                    <strong class="flex items-center gap-1.5">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                      </svg>
                      Colegio profesional:
                    </strong>
                    <span class="ml-6 text-blue-700">
                      {{ getPerfilSeleccionado()?.colegio }}
                    </span>
                  </p>
                </div>
              </div>

              <div class="space-y-4 p-5 bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200 rounded-xl">
                <label class="flex items-center gap-2 text-base font-medium text-gray-900">
                  <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                  </svg>
                  ¿Prescribirás o dispensarás medicamentos controlados?
                </label>
                <div class="space-y-3">
                  <div class="flex items-center space-x-3 p-4 border-2 rounded-xl transition-all cursor-pointer"
                       [ngClass]="{
                         'border-blue-600 bg-blue-50 shadow-md': formData.tipoMedicamentosControlados === 'ninguno',
                         'border-gray-300 bg-white hover:border-blue-300 hover:shadow-sm': formData.tipoMedicamentosControlados !== 'ninguno'
                       }">
                    <input type="radio" id="control-ninguno" name="tipoMedicamentosControlados" 
                           value="ninguno" [(ngModel)]="formData.tipoMedicamentosControlados"
                           (change)="onTipoMedicamentosChange()">
                    <label for="control-ninguno" class="flex-1 cursor-pointer">
                      <p class="font-medium">No, solo medicamentos de libre venta</p>
                      <p class="text-sm text-gray-600">Sin restricciones especiales</p>
                    </label>
                  </div>
                  <div class="flex items-center space-x-3 p-4 border-2 rounded-xl transition-all cursor-pointer"
                       [ngClass]="{
                         'border-blue-500 bg-blue-50 shadow-md': formData.tipoMedicamentosControlados === 'antimicrobianos',
                         'border-gray-300 bg-white hover:border-blue-300 hover:shadow-sm': formData.tipoMedicamentosControlados !== 'antimicrobianos'
                       }">
                    <input type="radio" id="control-antimicrobianos" name="tipoMedicamentosControlados" 
                           value="antimicrobianos" [(ngModel)]="formData.tipoMedicamentosControlados"
                           (change)="onTipoMedicamentosChange()">
                    <label for="control-antimicrobianos" class="flex-1 cursor-pointer">
                      <p class="font-medium">Antimicrobianos (Antibióticos)</p>
                      <p class="text-sm text-gray-600">Requiere registro especial</p>
                    </label>
                  </div>
                  <div class="flex items-center space-x-3 p-4 border-2 rounded-xl transition-all cursor-pointer"
                       [ngClass]="{
                         'border-orange-500 bg-orange-50 shadow-md': formData.tipoMedicamentosControlados === 'psicotropicos',
                         'border-orange-200 bg-orange-50/30 hover:border-orange-400 hover:shadow-sm': formData.tipoMedicamentosControlados !== 'psicotropicos'
                       }">
                    <input type="radio" id="control-psicotropicos" name="tipoMedicamentosControlados" 
                           value="psicotropicos" [(ngModel)]="formData.tipoMedicamentosControlados"
                           (change)="onTipoMedicamentosChange()">
                    <label for="control-psicotropicos" class="flex-1 cursor-pointer">
                      <p class="font-medium flex items-center gap-2">
                        <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Psicotrópicos
                      </p>
                      <p class="text-sm text-orange-700">Requiere Firma Digital obligatoria</p>
                    </label>
                  </div>
                  <div class="flex items-center space-x-3 p-4 border-2 rounded-xl transition-all cursor-pointer"
                       [ngClass]="{
                         'border-red-500 bg-red-50 shadow-md': formData.tipoMedicamentosControlados === 'estupefacientes',
                         'border-red-200 bg-red-50/30 hover:border-red-400 hover:shadow-sm': formData.tipoMedicamentosControlados !== 'estupefacientes'
                       }">
                    <input type="radio" id="control-estupefacientes" name="tipoMedicamentosControlados" 
                           value="estupefacientes" [(ngModel)]="formData.tipoMedicamentosControlados"
                           (change)="onTipoMedicamentosChange()">
                    <label for="control-estupefacientes" class="flex-1 cursor-pointer">
                      <p class="font-medium flex items-center gap-2">
                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        Estupefacientes
                      </p>
                      <p class="text-sm text-red-700">Requiere Firma Digital obligatoria</p>
                    </label>
                  </div>
                </div>
              </div>

              <div *ngIf="formData.tipoMedicamentosControlados !== 'ninguno'" 
                   class="space-y-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                  <div class="flex-1">
                    <h4 class="font-medium text-blue-900">Método de Autenticación Requerido</h4>
                    <p class="text-sm text-blue-700 mt-1">
                      {{ necesitaFirmaDigitalObligatoria() 
                        ? "Para estupefacientes y psicotrópicos es OBLIGATORIO usar Firma Digital BCCR."
                        : "Para antimicrobianos puedes usar Firma Digital o Usuario/Contraseña + MFA." }}
                    </p>
                  </div>
                </div>

                <div *ngIf="necesitaFirmaDigitalObligatoria()" class="p-3 bg-blue-100 border border-blue-300 rounded-lg">
                  <div class="flex items-center gap-2">
                    <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                    <span class="text-sm text-blue-800">
                      La Firma Digital ha sido seleccionada automáticamente por requisitos de seguridad nacional.
                      Configurarás tu firma digital en los siguientes pasos.
                    </span>
                  </div>
                </div>

                <!-- Selección de método de autenticación para antimicrobianos -->
                <div *ngIf="!necesitaFirmaDigitalObligatoria() && formData.tipoMedicamentosControlados === 'antimicrobianos'" class="space-y-3">
                  <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all cursor-pointer"
                       [ngClass]="{
                         'border-blue-500 bg-blue-50': formData.metodoAutenticacion === 'password',
                         'border-gray-300 bg-white': formData.metodoAutenticacion !== 'password'
                       }">
                    <input type="radio" id="auth-password" name="metodoAutenticacion" 
                           value="password" [(ngModel)]="formData.metodoAutenticacion">
                    <label for="auth-password" class="flex-1 cursor-pointer">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        <div>
                          <p class="font-medium">Usuario y Contraseña + MFA</p>
                          <p class="text-sm text-gray-600">Configurarás tus credenciales en los siguientes pasos</p>
                        </div>
                      </div>
                    </label>
                  </div>
                  <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all cursor-pointer"
                       [ngClass]="{
                         'border-blue-500 bg-blue-50': formData.metodoAutenticacion === 'digital_signature',
                         'border-gray-300 bg-white': formData.metodoAutenticacion !== 'digital_signature'
                       }">
                    <input type="radio" id="auth-signature" name="metodoAutenticacion" 
                           value="digital_signature" [(ngModel)]="formData.metodoAutenticacion">
                    <label for="auth-signature" class="flex-1 cursor-pointer">
                      <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <div>
                          <p class="font-medium">Firma Digital BCCR (GAUDI)</p>
                          <p class="text-sm text-gray-600">Máxima seguridad, configurarás tu firma en los siguientes pasos</p>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- PASO 2: Validación profesional -->
            <div *ngIf="currentStep === 1" class="space-y-5 animate-in fade-in slide-in-from-right-4 duration-500">
              <div class="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg">
                <div class="flex items-center gap-2 text-blue-900 mb-2">
                  <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h3M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <span class="font-medium">Validación con colegio profesional</span>
                </div>
                <p class="text-blue-700 text-sm">
                  Ingrese su código profesional para validar automáticamente sus datos con el
                  <strong>{{ getPerfilSeleccionado()?.colegio }}</strong>
                </p>
              </div>

              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                  </svg>
                  Código profesional
                </label>
                <div class="flex gap-3">
                  <input type="text" 
                         placeholder="Ej: MED-12345" 
                         [(ngModel)]="formData.codigoProfesional"
                         [disabled]="profesionalValidado"
                         class="flex-1 h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                  <button type="button" 
                          (click)="validarCodigoProfesional()" 
                          [disabled]="validandoProfesional || profesionalValidado || !formData.codigoProfesional"
                          class="h-12 px-6 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <span *ngIf="validandoProfesional" class="flex items-center gap-2">
                      <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                      Validando...
                    </span>
                    <span *ngIf="profesionalValidado && !validandoProfesional" class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      Validado
                    </span>
                    <span *ngIf="!validandoProfesional && !profesionalValidado">Validar</span>
                  </button>
                </div>
              </div>

              <div *ngIf="profesionalValidado" 
                   class="p-5 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl space-y-3 shadow-sm animate-in fade-in slide-in-from-top-2">
                <div class="flex items-center gap-2 text-green-900">
                  <div class="p-2 bg-green-100 rounded-full">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                  </div>
                  <h4 class="font-medium text-lg">Datos validados exitosamente</h4>
                </div>
                <div class="grid gap-2 ml-2 pl-10 border-l-2 border-green-300">
                  <p class="text-sm">
                    <span class="text-gray-600">Nombre:</span> 
                    <strong class="text-gray-900">{{ validationResult?.nombre }}</strong>
                  </p>
                  <p class="text-sm">
                    <span class="text-gray-600">Cédula:</span> 
                    <strong class="text-gray-900">{{ validationResult?.cedula }}</strong>
                  </p>
                  <p class="text-sm">
                    <span class="text-gray-600">Estado:</span> 
                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700 border border-green-300">
                      {{ validationResult?.estado }}
                    </span>
                  </p>
                </div>
              </div>
            </div>

            <!-- PASO 3: Datos básicos y credenciales -->
            <div *ngIf="currentStep === 2" class="space-y-4 animate-in fade-in slide-in-from-right-4 duration-500">
              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  Nombre completo
                </label>
                <input type="text" 
                       placeholder="Dr. Juan Pérez Rodríguez" 
                       [(ngModel)]="formData.nombreCompleto"
                       class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <label class="text-sm font-medium text-gray-900">Tipo de identificación</label>
                  <select [(ngModel)]="formData.tipoIdentificacion" 
                          class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    <option value="cedula">Cédula</option>
                    <option value="dimex">DIMEX</option>
                    <option value="pasaporte">Pasaporte</option>
                  </select>
                </div>

                <div class="space-y-2">
                  <label class="text-sm font-medium text-gray-900">Número</label>
                  <input type="text" 
                         [placeholder]="formData.tipoIdentificacion === 'cedula' ? '1-0234-0567' : 'Número'"
                         [(ngModel)]="formData.numeroIdentificacion"
                         (input)="formData.tipoIdentificacion === 'cedula' ? formatCedula($event) : null"
                         class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                </div>
              </div>

              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                  </svg>
                  Correo electrónico
                </label>
                <input type="email" 
                       placeholder="tucorreo@hospital.cr" 
                       [(ngModel)]="formData.correoElectronico"
                       class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>

              <div class="space-y-2">
                <label class="flex items-center gap-2 text-sm font-medium text-gray-900">
                  <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                  Teléfono móvil
                </label>
                <input type="tel" 
                       placeholder="+506 8888-7777" 
                       [(ngModel)]="formData.telefonoMovil"
                       class="w-full h-12 px-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
              </div>

              <div class="space-y-4">
                <div class="flex items-start gap-3">
                  <input type="checkbox" 
                         id="terminosCondiciones" 
                         [(ngModel)]="formData.aceptaTerminos"
                         class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                  <label for="terminosCondiciones" class="text-sm text-gray-700 leading-relaxed">
                    Acepto los <a href="#" class="text-blue-600 hover:text-blue-800 underline">Términos y Condiciones de Uso</a>
                  </label>
                </div>

                <div class="flex items-start gap-3">
                  <input type="checkbox" 
                         id="politicaPrivacidad" 
                         [(ngModel)]="formData.aceptaPrivacidad"
                         class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                  <label for="politicaPrivacidad" class="text-sm text-gray-700 leading-relaxed">
                    Acepto la <a href="#" class="text-blue-600 hover:text-blue-800 underline">Política de Privacidad y Protección de Datos</a>
                  </label>
                </div>
              </div>

              <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                  <div>
                    <h4 class="font-medium text-yellow-900 mb-1">Importante:</h4>
                    <p class="text-sm text-yellow-800">
                      ePrescription no recopila datos personales sensibles sin consentimiento explícito y cumple con normativas internacionales de privacidad.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- PASO 4: Verificación de contacto -->
            <div *ngIf="currentStep === 3" class="space-y-5 animate-in fade-in slide-in-from-right-4 duration-500">
              
              <!-- Estado: Teléfono verificado (si aplica) -->
              <div *ngIf="telefonoVerificado" class="flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                  <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 8 8">
                    <path d="M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z"/>
                  </svg>
                </div>
                <span class="text-sm font-medium text-green-800">Teléfono verificado</span>
              </div>

              <!-- Verificación de correo electrónico -->
              <div class="space-y-4">
                <div class="p-4 border border-gray-200 rounded-lg">
                  <div class="flex items-start gap-3 mb-4">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <div class="flex-1">
                      <h3 class="font-medium text-gray-900 mb-1">Verificar correo electrónico</h3>
                      <p class="text-sm text-gray-600">{{ formData.correoElectronico }}</p>
                    </div>
                    <div *ngIf="correoVerificado" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                      <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 8 8">
                        <path d="M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z"/>
                      </svg>
                    </div>
                  </div>

                  <!-- Botón para enviar código o campo para ingresar código -->
                  <div *ngIf="!codigoCorreoEnviado && !correoVerificado">
                    <button type="button" 
                            (click)="enviarCodigoCorreo()" 
                            [disabled]="enviandoCodigoCorreo"
                            class="w-full h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                      <span *ngIf="enviandoCodigoCorreo" class="flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Enviando...
                      </span>
                      <span *ngIf="!enviandoCodigoCorreo">Enviar código de verificación</span>
                    </button>
                  </div>

                  <div *ngIf="codigoCorreoEnviado && !correoVerificado" class="space-y-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Código de verificación</label>
                      <div class="flex gap-3">
                        <input type="text" 
                               [(ngModel)]="formData.codigoCorreo"
                               placeholder="000000"
                               maxlength="6"
                               class="flex-1 h-11 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-center font-mono text-lg">
                        <button type="button" 
                                (click)="verificarCodigoCorreo()" 
                                [disabled]="verificandoCorreo || !formData.codigoCorreo"
                                class="px-6 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                          <span *ngIf="verificandoCorreo">Verificando...</span>
                          <span *ngIf="!verificandoCorreo">Verificar</span>
                        </button>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500">El código expira en 15 minutos</p>
                  </div>
                </div>

                <!-- Verificación de teléfono -->
                <div class="p-4 border border-gray-200 rounded-lg">
                  <div class="flex items-start gap-3 mb-4">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <div class="flex-1">
                      <h3 class="font-medium text-gray-900 mb-1">Verificar teléfono</h3>
                      <p class="text-sm text-gray-600">{{ formData.telefonoMovil }}</p>
                    </div>
                    <div *ngIf="telefonoVerificado" class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                      <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 8 8">
                        <path d="M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z"/>
                      </svg>
                    </div>
                  </div>

                  <!-- Botón para enviar código o campo para ingresar código -->
                  <div *ngIf="!codigoTelefonoEnviado && !telefonoVerificado">
                    <button type="button" 
                            (click)="enviarCodigoTelefono()" 
                            [disabled]="enviandoCodigoTelefono"
                            class="w-full h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                      <span *ngIf="enviandoCodigoTelefono" class="flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Enviando...
                      </span>
                      <span *ngIf="!enviandoCodigoTelefono">Enviar código por SMS</span>
                    </button>
                  </div>

                  <div *ngIf="codigoTelefonoEnviado && !telefonoVerificado" class="space-y-3">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Código de verificación</label>
                      <div class="flex gap-3">
                        <input type="text" 
                               [(ngModel)]="formData.codigoTelefono"
                               placeholder="123132"
                               maxlength="6"
                               class="flex-1 h-11 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-center font-mono text-lg">
                        <button type="button" 
                                (click)="verificarCodigoTelefono()" 
                                [disabled]="verificandoTelefono || !formData.codigoTelefono"
                                class="px-6 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                          <span *ngIf="verificandoTelefono">Verificando...</span>
                          <span *ngIf="!verificandoTelefono">Verificar</span>
                        </button>
                      </div>
                    </div>
                    <p class="text-xs text-gray-500">El código expira en 5 minutos</p>
                  </div>
                </div>
              </div>

              <!-- Mensaje informativo -->
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <p class="text-sm text-blue-800">
                    Las verificaciones de correo y teléfono son obligatorias para garantizar la seguridad de tu cuenta.
                  </p>
                </div>
              </div>
            </div>

            <!-- PASO 5: Configuración de autenticación -->
            <div *ngIf="currentStep === 4" class="space-y-4 animate-in fade-in slide-in-from-right-4 duration-500">
              
              <!-- Configuración para Firma Digital -->
              <div *ngIf="formData.metodoAutenticacion === 'digital_signature'">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <div>
                      <h4 class="font-medium text-blue-900 mb-1">Firma Digital BCCR (GAUDI)</h4>
                      <p class="text-sm text-blue-800">
                        Necesitas tu certificado digital (.p12) emitido por el Banco Central de Costa Rica
                      </p>
                    </div>
                  </div>
                </div>

                <div class="space-y-4">
                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Archivo de firma digital (.p12)</label>
                    <div class="flex gap-2">
                      <input type="file" 
                             accept=".p12,.pfx"
                             (change)="onFileSelected($event)"
                             class="flex-1 h-11 px-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div *ngIf="formData.archivoFirmaDigital" class="text-sm text-green-600">
                      ✓ {{ formData.archivoFirmaDigital.name }}
                    </div>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">PIN del certificado</label>
                    <input type="password" 
                           [(ngModel)]="formData.pinCertificado"
                           placeholder="Ingrese el PIN de su firma digital"
                           maxlength="8"
                           class="w-full h-11 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    <p class="text-xs text-gray-500">
                      El PIN es requerido para validar el certificado
                    </p>
                  </div>
                </div>
              </div>

              <!-- Configuración para Usuario/Contraseña + MFA -->
              <div *ngIf="formData.metodoAutenticacion === 'password'">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                  <div class="flex items-start gap-2">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <div>
                      <p class="text-sm text-blue-800">
                        <strong>Recomendado:</strong> Activa la autenticación de dos factores (MFA) para proteger tu cuenta contra accesos no autorizados.
                      </p>
                    </div>
                  </div>
                </div>

                <div class="space-y-3">
                  <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg"
                       [ngClass]="{
                         'border-blue-500 bg-blue-50': formData.configureMFA === 'now',
                         'border-gray-300 bg-white': formData.configureMFA !== 'now'
                       }">
                    <input type="radio" id="mfa-now" name="configureMFA" 
                           value="now" [(ngModel)]="formData.configureMFA">
                    <label for="mfa-now" class="flex-1 cursor-pointer">
                      Configurar ahora (recomendado)
                    </label>
                  </div>
                  <div class="flex items-center space-x-3 p-3 border border-gray-300 rounded-lg"
                       [ngClass]="{
                         'border-blue-500 bg-blue-50': formData.configureMFA === 'later',
                         'border-gray-300 bg-white': formData.configureMFA !== 'later'
                       }">
                    <input type="radio" id="mfa-later" name="configureMFA" 
                           value="later" [(ngModel)]="formData.configureMFA">
                    <label for="mfa-later" class="flex-1 cursor-pointer">
                      Configurar más tarde
                    </label>
                  </div>
                </div>

                <!-- Botón para generar QR -->
                <div *ngIf="formData.configureMFA === 'now' && !formData.totpSecret">
                  <button type="button" 
                          (click)="generarCodigoQR()" 
                          [disabled]="generandoQR"
                          class="w-full h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                    <span *ngIf="generandoQR" class="flex items-center justify-center gap-2">
                      <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                      </svg>
                      Generando...
                    </span>
                    <span *ngIf="!generandoQR">Generar código QR para MFA</span>
                  </button>
                </div>

                <!-- Configuración de TOTP -->
                <div *ngIf="formData.totpSecret && !mfaConfigured" class="space-y-4 p-4 border border-gray-300 rounded-lg">
                  <div class="text-center">
                    <div class="inline-block p-4 bg-white border-2 border-gray-300 rounded-lg">
                      <!-- Placeholder QR code -->
                      <div class="w-48 h-48 bg-gray-100 flex items-center justify-center">
                        <p class="text-sm text-gray-500">Código QR<br/>{{ formData.totpSecret }}</p>
                      </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                      Escanea con Google Authenticator o similar
                    </p>
                  </div>

                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Código de verificación (6 dígitos)</label>
                    <div class="flex gap-2">
                      <input type="text" 
                             [(ngModel)]="formData.totpCode"
                             placeholder="000000"
                             maxlength="6"
                             class="flex-1 h-11 px-4 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-center font-mono text-lg">
                      <button type="button" 
                              (click)="verificarTOTP()" 
                              [disabled]="verificandoCorreo || !formData.totpCode || formData.totpCode.length !== 6"
                              class="px-6 h-11 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all disabled:opacity-50">
                        <span *ngIf="verificandoCorreo">Verificando...</span>
                        <span *ngIf="!verificandoCorreo">Verificar</span>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Confirmación MFA configurado -->
                <div *ngIf="mfaConfigured" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-sm font-medium text-green-800">MFA configurado exitosamente</span>
                  </div>
                </div>
              </div>

              <!-- Mensaje cuando no hay método de autenticación seleccionado -->
              <div *ngIf="!formData.metodoAutenticacion || (formData.metodoAutenticacion !== 'digital_signature' && formData.metodoAutenticacion !== 'password')" 
                   class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                  <div>
                    <h4 class="font-medium text-yellow-900 mb-1">Método de autenticación no definido</h4>
                    <p class="text-sm text-yellow-800 mb-3">
                      Regresa al paso 1 para seleccionar tu método de autenticación según el tipo de medicamentos que manejarás.
                    </p>
                    <button type="button" 
                            (click)="asegurarMetodoAutenticacion()" 
                            class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm font-medium transition-colors">
                      Asignar método automáticamente
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- PASO 6: Confirmación -->
            <div *ngIf="currentStep === 5" class="space-y-5 animate-in fade-in slide-in-from-right-4 duration-500">
              <div class="flex items-center gap-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center">
                  <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 8 8">
                    <path d="M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z"/>
                  </svg>
                </div>
                <span class="text-sm font-medium text-green-800">Teléfono verificado</span>
              </div>

              <div class="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="w-4 h-4 bg-green-500 rounded-full flex items-center justify-center mt-0.5">
                  <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 8 8">
                    <path d="M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z"/>
                  </svg>
                </div>
                <div>
                  <span class="text-sm font-medium text-green-800">Datos listos para enviar</span>
                  <p class="text-xs text-green-700 mt-1">
                    Tu solicitud será revisada por un administrador. Recibirás una notificación cuando sea aprobada.
                  </p>
                </div>
              </div>

              <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <h4 class="font-medium text-gray-900 mb-3">Resumen de tu solicitud</h4>
              </div>

              <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                <div class="divide-y divide-gray-200">
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Perfil:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ getPerfilSeleccionado()?.label }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Código profesional:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ formData.codigoProfesional }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Nombre:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ formData.nombreCompleto }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Identificación:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ formData.tipoIdentificacion }}: {{ formData.numeroIdentificacion }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Correo:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ formData.correoElectronico }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Teléfono:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ formData.telefonoMovil }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Medicamentos:</span>
                    <span class="text-sm text-gray-900 font-medium">{{ getMedicamentosLabel() }}</span>
                  </div>
                  <div class="flex justify-between p-3">
                    <span class="text-sm text-gray-600 w-32 flex-shrink-0">Autenticación:</span>
                    <span class="text-sm text-gray-900 font-medium">Usuario/Contraseña + MFA</span>
                  </div>
                </div>
              </div>

              <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start gap-2">
                  <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                  </svg>
                  <div>
                    <h4 class="font-medium text-yellow-900 mb-1">Estado:</h4>
                    <p class="text-sm text-yellow-800">
                      Tu cuenta quedará en estado "Pendiente de aprobación" hasta que un administrador la revise y apruebe. 
                      Recibirás una notificación por correo electrónico cuando tu cuenta sea activada.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Botones de navegación -->
            <div class="flex justify-between items-center mt-12 pt-6">
              <div>
                <button *ngIf="currentStep === 0" 
                        type="button" 
                        (click)="cancelarRegistro()" 
                        class="flex items-center gap-2 h-11 px-6 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Cancelar
                </button>
                <button *ngIf="currentStep > 0" 
                        type="button" 
                        (click)="previousStep()" 
                        class="flex items-center gap-2 text-gray-600 hover:text-blue-600 text-sm transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                  Atrás
                </button>
              </div>
              
              <div>
                <button *ngIf="currentStep < steps.length - 1" 
                        type="button" 
                        (click)="nextStep()" 
                        [disabled]="!isCurrentStepValid()"
                        class="flex items-center gap-2 h-11 px-6 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                  Continuar
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
                
                <button *ngIf="currentStep === steps.length - 1" 
                        type="button" 
                        (click)="enviarSolicitud()" 
                        [disabled]="enviandoSolicitud"
                        class="flex items-center gap-2 h-11 px-6 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                  <svg *ngIf="enviandoSolicitud" class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                  </svg>
                  {{ enviandoSolicitud ? 'Enviando...' : 'Enviar solicitud' }}
                </button>
              </div>
            </div>

            <!-- Enlaces adicionales -->
            <div class="text-center mt-8">
              <p class="text-sm text-gray-600 mb-2">¿Ya tienes una cuenta?</p>
              <button type="button" 
                      (click)="volverAlLogin()" 
                      class="flex items-center gap-2 text-gray-600 hover:text-blue-600 text-sm transition-colors mx-auto">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Volver al inicio de sesión
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de éxito -->
<div *ngIf="solicitudEnviada" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl text-center max-w-md w-full p-8 animate-in fade-in slide-in-from-bottom-4 duration-300">
    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6">
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h2 class="text-2xl font-semibold text-gray-900 mb-4">¡Solicitud enviada!</h2>
    <p class="text-gray-600 mb-8 leading-relaxed">
      Tu solicitud ha sido enviada correctamente. Recibirás una notificación cuando sea aprobada por un administrador.
    </p>
    <button type="button" 
            (click)="volverAlLogin()" 
            class="w-full h-12 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
      Ir al inicio de sesión
    </button>
  </div>
</div>