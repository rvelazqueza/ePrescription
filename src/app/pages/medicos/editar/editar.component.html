<div class="space-y-6">
  <!-- Toast notifications -->
  <app-toast></app-toast>
  
  <!-- Breadcrumbs -->
  <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>
  
  <!-- Page Header -->
  <app-page-header 
    title="Alta/Edición de Médicos" 
    description="Gestión completa de profesionales médicos del sistema"
    [icon]="stethoscopeIcon">
    <button 
      slot="action"
      (click)="onNewDoctor()"
      class="bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center gap-2 backdrop-blur-sm border border-white/30">
      <lucide-icon [img]="plusIcon" class="w-4 h-4"></lucide-icon>
      Registrar nuevo médico
    </button>
  </app-page-header>

  <!-- Doctor Stats Cards -->
  <app-doctor-stats-cards 
    [doctors]="filteredDoctors">
  </app-doctor-stats-cards>

  <!-- Búsqueda y filtros -->
  <app-doctor-search-tabs
    [doctors]="allDoctors"
    (filtersChanged)="onFiltersChanged($event)"
    #searchTabs>
  </app-doctor-search-tabs>

  <!-- Results Summary -->
  <div *ngIf="searchResultsCount !== null" class="mb-6" role="status" aria-live="polite">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center">
        <lucide-icon 
          [img]="infoIcon" 
          class="w-5 h-5 text-blue-600 mr-2"
          [strokeWidth]="2"
          aria-hidden="true">
        </lucide-icon>
        <span class="text-blue-800 font-medium">
          {{ searchResultsCount }} médicos encontrados
          <span *ngIf="searchResultsCount !== allDoctors.length" class="text-blue-600">
            de {{ allDoctors.length }} total
          </span>
        </span>
      </div>
    </div>
  </div>

  <!-- Doctors Table -->
  <div class="bg-white rounded-lg shadow overflow-hidden" role="region" aria-labelledby="doctors-table-title">
    <!-- Table Header -->
    <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-blue-100 rounded-lg">
            <lucide-icon [img]="stethoscopeIcon" class="w-5 h-5 text-blue-600"></lucide-icon>
          </div>
          <div>
            <h3 id="doctors-table-title" class="text-lg font-semibold text-gray-900">Médicos Registrados</h3>
            <p class="text-sm text-gray-600 mt-1">
              {{ filteredDoctors.length }} médico{{ filteredDoctors.length !== 1 ? 's' : '' }} encontrado{{ filteredDoctors.length !== 1 ? 's' : '' }} • Doble clic para vista rápida
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="p-8 text-center" role="status" aria-live="polite">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3" aria-hidden="true"></div>
        <span class="text-gray-600">Cargando médicos...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!isLoading && filteredDoctors.length === 0" class="p-12 text-center" role="status">
      <div class="max-w-md mx-auto">
        <lucide-icon 
          [img]="searchIcon" 
          class="w-12 h-12 text-gray-400 mx-auto mb-4"
          [strokeWidth]="1.5"
          aria-hidden="true">
        </lucide-icon>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron médicos</h3>
        <p class="text-gray-600 mb-6">
          No hay médicos que coincidan con los criterios de búsqueda actuales.
        </p>
        <button
          type="button"
          (click)="clearAllFilters()"
          class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          aria-label="Limpiar todos los filtros de búsqueda">
          <lucide-icon 
            [img]="refreshIcon" 
            class="w-4 h-4 mr-2"
            [strokeWidth]="2"
            aria-hidden="true">
          </lucide-icon>
          Limpiar filtros
        </button>
      </div>
    </div> 

    <!-- Table Content -->
    <div class="p-0">
      <div *ngIf="!isLoading && filteredDoctors.length > 0" class="overflow-x-auto" style="max-height: 500px; overflow-y: auto;">
        <table class="w-full min-w-[1200px]" role="table" aria-label="Lista de médicos registrados">
          <thead class="bg-gray-50 sticky top-0">
            <tr role="row">
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Médico</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Especialidad</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Licencia</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Contacto</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Experiencia</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Recetas</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Estado</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider" scope="col">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr 
              *ngFor="let doctor of filteredDoctors; trackBy: trackByDoctorId; let i = index"
              (dblclick)="onDoctorDoubleClick(doctor)"
              (keydown.enter)="onDoctorDoubleClick(doctor)"
              (keydown.space)="onDoctorDoubleClick(doctor)"
              class="hover:bg-blue-50/50 cursor-pointer transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-inset stagger-item"
              role="row"
              tabindex="0"
              [attr.aria-label]="'Médico ' + doctor.fullName + ', especialidad ' + doctor.specialty"
              [attr.aria-describedby]="'doctor-' + doctor.id + '-description'"
              [style.animation-delay]="(i * 0.05) + 's'"
              title="Doble clic para ver detalles">
            
            <!-- Doctor Info -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-12 w-12">
                  <div 
                    class="h-12 w-12 rounded-full flex items-center justify-center text-white font-semibold text-sm"
                    [ngClass]="getDoctorAvatarClass(doctor)">
                    {{ getDoctorInitials(doctor.fullName) }}
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{ doctor.fullName }}</div>
                  <div class="text-sm text-gray-500">{{ doctor.email }}</div>
                </div>
              </div>
            </td>

            <!-- Specialty -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 font-medium">{{ doctor.specialty }}</div>
              <div *ngIf="doctor.subspecialties.length > 0" class="text-xs text-gray-500 mt-1">
                {{ doctor.subspecialties.slice(0, 2).join(', ') }}
                <span *ngIf="doctor.subspecialties.length > 2" class="text-gray-400">
                  +{{ doctor.subspecialties.length - 2 }} más
                </span>
              </div>
            </td>

            <!-- License -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 font-mono">{{ doctor.licenseNumber }}</div>
              <div class="text-xs mt-1" [ngClass]="getLicenseExpiryClass(doctor.licenseExpiry)">
                Vence: {{ doctor.licenseExpiry }}
              </div>
            </td>

            <!-- Contact -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ doctor.phone }}</div>
              <div *ngIf="doctor.officePhone" class="text-xs text-gray-500 mt-1">
                Oficina: {{ doctor.officePhone }}
              </div>
            </td>

            <!-- Experience -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 font-medium">{{ doctor.yearsOfExperience }} años</div>
              <div class="text-xs text-gray-500 mt-1">{{ doctor.university }}</div>
            </td>

            <!-- Prescriptions -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900 font-medium">{{ doctor.totalPrescriptions | number }}</div>
              <div class="text-xs text-gray-500 mt-1">
                {{ doctor.monthlyPrescriptions }} este mes
              </div>
            </td>

            <!-- Status -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-col space-y-1">
                <span 
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                  [ngClass]="getStatusBadgeClass(doctor.status)">
                  <span class="w-1.5 h-1.5 rounded-full mr-1.5" [ngClass]="getStatusDotClass(doctor.status)"></span>
                  {{ getStatusText(doctor.status) }}
                </span>
                <span 
                  *ngIf="doctor.isOnDuty"
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-1.5"></span>
                  En turno
                </span>
              </div>
            </td>

            <!-- Actions -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <div class="relative">
                <button 
                  (click)="toggleAccionesModal(doctor.id); $event.stopPropagation()"
                  class="p-2 text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition-colors"
                  title="Más acciones"
                >
                  <lucide-icon [img]="moreVerticalIcon" class="w-5 h-5"></lucide-icon>
                </button>
                
                <!-- Modal de acciones -->
                <div 
                  *ngIf="modalAccionesAbierto === doctor.id"
                  (click)="$event.stopPropagation()"
                  class="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
                >
                  <div class="py-2">
                    <div class="px-4 py-2 text-sm font-medium text-gray-700 border-b border-gray-100">
                      Acciones
                    </div>
                    
                    <button 
                      (click)="onViewDoctor(doctor); cerrarModalAcciones()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="eyeIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Ver detalles
                    </button>
                    
                    <button 
                      (click)="onEditDoctor(doctor); cerrarModalAcciones()"
                      class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3"
                    >
                      <lucide-icon [img]="editIcon" class="w-4 h-4 text-gray-500"></lucide-icon>
                      Editar médico
                    </button>
                    
                    <div class="border-t border-gray-100 mt-1 pt-1">
                      <button 
                        (click)="onDeleteDoctor(doctor); cerrarModalAcciones()"
                        class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-3"
                      >
                        <lucide-icon [img]="trashIcon" class="w-4 h-4 text-red-500"></lucide-icon>
                        Eliminar médico
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="!isLoading && filteredDoctors.length > 0" class="px-6 py-4 border-t border-gray-200 bg-gray-50" role="navigation" aria-label="Paginación de médicos">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-700" aria-live="polite">
          Mostrando 
          <span class="font-medium">{{ getDisplayRange().start }}</span> 
          a 
          <span class="font-medium">{{ getDisplayRange().end }}</span> 
          de 
          <span class="font-medium">{{ filteredDoctors.length }}</span> 
          médicos
        </div>
        <div class="flex items-center space-x-2">
          <button
            type="button"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            aria-label="Ir a la página anterior">
            Anterior
          </button>
          <div class="flex space-x-1" role="group" aria-label="Páginas">
            <button
              *ngFor="let page of getVisiblePages()"
              type="button"
              (click)="goToPage(page)"
              class="px-3 py-2 text-sm font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [ngClass]="{
                'bg-blue-600 text-white': page === currentPage,
                'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50': page !== currentPage
              }"
              [attr.aria-label]="'Ir a la página ' + page"
              [attr.aria-current]="page === currentPage ? 'page' : null">
              {{ page }}
            </button>
          </div>
          <button
            type="button"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
            class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            aria-label="Ir a la página siguiente">
            Siguiente
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Información sobre médicos -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start">
      <lucide-icon [img]="infoIcon" class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" aria-hidden="true"></lucide-icon>
      <div>
        <h4 class="text-sm font-medium text-blue-900 mb-1">Información sobre médicos</h4>
        <p class="text-sm text-blue-700">
          Haz doble clic en cualquier fila para ver detalles rápidos del médico. Usa el menú de acciones para editar información o gestionar el estado del médico. Los médicos inactivos no pueden emitir nuevas prescripciones.
        </p>
      </div>
    </div>
  </div>

</div>

<!-- Doctor Detail Panel -->
<app-doctor-detail-panel
  [doctor]="selectedDoctor"
  [isVisible]="isDetailPanelVisible"
  (close)="onCloseDetailPanel()">
</app-doctor-detail-panel>

<!-- New Doctor Modal -->
<app-new-doctor-modal
  *ngIf="isNewDoctorModalVisible"
  (close)="onCloseNewDoctorModal()"
  (doctorCreated)="onDoctorCreated($event)">
</app-new-doctor-modal>