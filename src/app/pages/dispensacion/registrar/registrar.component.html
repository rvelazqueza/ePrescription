<!-- Breadcrumbs -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="space-y-6">
  
  <!-- Banner de encabezado -->
  <div
    class="relative overflow-hidden bg-gradient-to-r from-green-600 via-emerald-500 to-teal-600 rounded-lg shadow-lg">
    <div class="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
    <div class="relative p-6 lg:p-8">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center space-x-3 mb-2">
            <div class="p-3 bg-white/20 backdrop-blur-sm rounded-lg">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M7 4V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2h4a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h4zM9 3v1h6V3H9zm11 3H4v14h16V6z"/>
              </svg>
            </div>
            <div>
              <h1 class="text-white text-3xl font-bold">Registrar Dispensación</h1>
              <p class="text-emerald-100 text-sm">
                Dispensación de medicamentos prescritos con verificación farmacéutica
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Indicador de paso actual -->
  <div class="bg-white border border-blue-200 rounded-lg shadow-sm">
    <div class="p-4">
      <div class="flex items-center justify-center gap-8">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full flex items-center justify-center"
               [ngClass]="{
                 'bg-blue-600 text-white': currentStep === 'select',
                 'bg-green-600 text-white': currentStep === 'dispense'
               }">
            <lucide-angular 
              *ngIf="currentStep === 'dispense'" 
              [img]="checkCircle2Icon" 
              class="w-5 h-5">
            </lucide-angular>
            <span *ngIf="currentStep === 'select'">1</span>
          </div>
          <span class="font-medium"
                [ngClass]="{
                  'text-blue-600': currentStep === 'select',
                  'text-green-600': currentStep === 'dispense'
                }">
            Seleccionar Receta
          </span>
        </div>

        <div class="w-16 h-0.5 bg-gray-300"></div>

        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-full flex items-center justify-center"
               [ngClass]="{
                 'bg-blue-600 text-white': currentStep === 'dispense',
                 'bg-gray-300 text-gray-600': currentStep === 'select'
               }">
            2
          </div>
          <span class="font-medium"
                [ngClass]="{
                  'text-blue-600': currentStep === 'dispense',
                  'text-gray-600': currentStep === 'select'
                }">
            Registrar Dispensación
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Paso 1: Selector de Recetas -->
  <div *ngIf="currentStep === 'select'">
    <!-- Información del paso -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg">
      <div class="p-4 lg:p-6">
        <div class="flex items-start space-x-3">
          <div class="p-2 bg-blue-100 rounded-lg">
            <lucide-angular [img]="fileCheckIcon" class="w-5 h-5 text-blue-600"></lucide-angular>
          </div>
          <div>
            <h3 class="font-medium text-blue-900 mb-2">Paso 1: Seleccionar Receta a Dispensar</h3>
            <p class="text-sm text-blue-800">
              Busque y seleccione la receta médica que desea dispensar. Solo se muestran recetas emitidas y verificadas.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Buscador y filtros -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200">
      <div class="p-4 lg:p-6 border-b border-gray-200">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Buscar Receta</h3>
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">{{ filteredPrescriptions.length }} recetas encontradas</span>
            <span class="text-sm font-medium text-green-600">{{ availablePrescriptionsCount }} disponible(s) para dispensar</span>
          </div>
        </div>

        <!-- Barra de búsqueda -->
        <div class="flex gap-3">
          <div class="flex-1 relative">
            <lucide-angular [img]="searchIcon" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></lucide-angular>
            <input
              type="text"
              [(ngModel)]="searchText"
              placeholder="Buscar por número de receta, paciente, cédula, QR o token..."
              class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <button
            (click)="toggleFilters()"
            class="flex items-center gap-2 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            <lucide-angular [img]="filterIcon" class="w-4 h-4"></lucide-angular>
            Filtros
          </button>
        </div>
      </div>

      <!-- Lista de recetas -->
      <div class="p-4 lg:p-6">
        <div class="space-y-3">
          <div 
            *ngFor="let prescription of filteredPrescriptions"
            class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:bg-blue-50 transition-all cursor-pointer"
            [ngClass]="{
              'opacity-50': !canSelectPrescription(prescription),
              'hover:shadow-md': canSelectPrescription(prescription)
            }"
            (click)="canSelectPrescription(prescription) && handleSelectPrescription(prescription)"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <lucide-angular [img]="fileCheckIcon" class="w-4 h-4 text-blue-600"></lucide-angular>
                  <span class="font-semibold text-gray-900">{{ prescription.prescriptionNumber }}</span>
                  <span 
                    class="px-2 py-1 text-xs rounded-full border"
                    [ngClass]="getStatusBadge(prescription.verificationStatus).className"
                  >
                    {{ getStatusBadge(prescription.verificationStatus).label }}
                  </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p class="font-medium text-gray-900">{{ prescription.patientName }}</p>
                    <p class="text-gray-600">{{ prescription.patientId }} • {{ prescription.age }} años • {{ prescription.gender === 'M' ? 'Masculino' : 'Femenino' }}</p>
                  </div>
                  <div>
                    <p class="text-gray-600">{{ prescription.medicinesCount }} medicamento(s) prescrito(s)</p>
                    <p class="text-gray-600">Médico: {{ prescription.doctorName }}</p>
                  </div>
                </div>

                <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                  <span>Emitida: {{ prescription.emittedDate }} {{ prescription.emittedTime }}</span>
                  <span>Válida hasta: {{ prescription.validUntil }}</span>
                  <span>QR: {{ prescription.qrCode }}</span>
                  <span>Token: {{ prescription.token }}</span>
                </div>
              </div>

              <div class="flex items-center gap-3">
                <div *ngIf="canSelectPrescription(prescription)" class="text-right">
                  <button
                    (click)="handleSelectPrescription(prescription); $event.stopPropagation()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2"
                  >
                    Seleccionar
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                  </button>
                </div>
                <div *ngIf="!canSelectPrescription(prescription)" class="text-gray-400">
                  <span class="text-sm">No disponible</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Estado vacío -->
          <div *ngIf="filteredPrescriptions.length === 0" class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <lucide-angular [img]="searchIcon" class="w-8 h-8 text-gray-400"></lucide-angular>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron recetas</h3>
            <p class="text-gray-600">Intente con otros términos de búsqueda o verifique los filtros aplicados.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Paso 2: Registrar Dispensación -->
  <div *ngIf="currentStep === 'dispense' && selectedPrescription">
    <!-- Header de la receta seleccionada -->
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg">
      <div class="p-4 lg:p-6">
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-4">
            <div class="p-3 bg-green-100 rounded-lg">
              <lucide-angular [img]="fileCheckIcon" class="w-6 h-6 text-green-600"></lucide-angular>
            </div>
            <div>
              <div class="flex items-center gap-2 mb-1">
                <h3 class="font-semibold text-green-900">Receta Seleccionada</h3>
                <span class="px-2 py-1 bg-green-100 text-green-800 border border-green-300 text-xs rounded-full">
                  Verificada
                </span>
              </div>
              <div class="text-sm text-green-800 space-y-1">
                <p><strong>{{ selectedPrescription.prescriptionNumber }}</strong> • {{ selectedPrescription.patientName }}</p>
                <p class="text-xs">{{ selectedPrescription.medicinesCount }} medicamento(s) prescrito(s) por {{ selectedPrescription.doctorName }}</p>
              </div>
            </div>
          </div>
          <button
            (click)="handleBackToSelection()"
            class="flex items-center gap-2 px-3 py-2 border border-green-300 bg-white hover:bg-green-50 text-green-700 rounded-lg transition-colors"
          >
            <lucide-angular [img]="xIcon" class="w-4 h-4"></lucide-angular>
            Cambiar Receta
          </button>
        </div>
      </div>
    </div>

  <!-- Header de la prescripción -->
  <div class="bg-white rounded-lg shadow-lg border border-gray-200">
    <div class="p-4 lg:p-6 border-b border-gray-200">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="p-2 bg-green-100 rounded-lg">
            <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
            </svg>
          </div>
          <div>
            <h2 class="text-xl font-semibold text-gray-900">Prescripción Médica Electrónica</h2>
            <p class="text-sm text-gray-600">{{ prescriptionData.prescriptionNumber }}</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <span class="px-3 py-1 bg-orange-100 text-orange-700 text-sm rounded-full border border-orange-300">
            Borrador
          </span>
          <span class="text-sm text-gray-500">{{ prescriptionData.issueDate }} {{ prescriptionData.issueTime }}</span>
        </div>
      </div>

      <!-- Información del paciente -->
      <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
        <div class="flex items-center space-x-4">
          <div class="w-16 h-16 bg-blue-200 rounded-full flex items-center justify-center">
            <span class="text-blue-700 font-bold text-lg">{{ getPatientInitials() }}</span>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-blue-900">{{ prescriptionData.patientName }}</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2 text-sm">
              <div>
                <span class="text-blue-600 font-medium">Género:</span>
                <span class="text-blue-800 ml-1">{{ prescriptionData.patientGender }}</span>
              </div>
              <div>
                <span class="text-blue-600 font-medium">Edad:</span>
                <span class="text-blue-800 ml-1">{{ prescriptionData.patientAge }} años</span>
              </div>
              <div>
                <span class="text-blue-600 font-medium">ID:</span>
                <span class="text-blue-800 ml-1">{{ prescriptionData.patientId }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-blue-200">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-blue-600 font-medium">Información del Médico</span>
              <p class="text-blue-800">{{ prescriptionData.doctorName }}</p>
              <p class="text-blue-700">{{ prescriptionData.doctorCode }}</p>
            </div>
            <div>
              <span class="text-blue-600 font-medium">Información de Contacto</span>
              <p class="text-blue-800">+57 (1) 234-5678</p>
              <p class="text-blue-700">contacto&#64;hospital.com</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección principal con tabla de medicamentos -->
  <div class="bg-white rounded-lg shadow-lg border border-blue-100">
    <div
      class="flex flex-row items-center justify-between p-4 lg:p-6 bg-gradient-to-r from-primary/5 to-transparent border-b border-primary/10">
      <div class="flex items-center space-x-3">
        <div class="p-2 bg-blue-100 rounded-lg">
          <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
          </svg>
        </div>
        <div>
          <h3 class="text-xl font-semibold text-gray-900">Medicamentos a Dispensar</h3>
          <p class="text-sm text-gray-600">
            Doble clic en cualquier fila para ver detalles y editar • {{ medicines.length }} medicamento{{
            medicines.length !== 1 ? 's' : '' }}
          </p>
        </div>
      </div>
      <div class="flex items-center space-x-2">
        <span class="px-3 py-1 bg-blue-50 text-blue-700 text-sm rounded-full border border-blue-200 flex items-center">
          <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z" />
          </svg>
          En proceso
        </span>
        <button (click)="openAddMedicineModal()"
          class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
          Agregar Medicamento
        </button>
      </div>
    </div>

    <div class="p-4 lg:p-6">
      <!-- Tabla de medicamentos -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-3 px-4 font-medium text-gray-700">Medicamento</th>
              <th class="text-left py-3 px-4 font-medium text-gray-700">Cantidad</th>
              <th class="text-left py-3 px-4 font-medium text-gray-700">Dosis</th>
              <th class="text-left py-3 px-4 font-medium text-gray-700">Frecuencia</th>
              <th class="text-left py-3 px-4 font-medium text-gray-700">Vía de Administración</th>
              <th class="text-left py-3 px-4 font-medium text-gray-700">Duración</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let medicine of medicines; trackBy: trackByMedicineId"
              (dblclick)="openEditMedicineModal(medicine)"
              class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors">
              <td class="py-4 px-4">
                <div class="flex items-center space-x-3">
                  <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                  </div>
                  <span class="font-medium text-gray-900">{{ medicine.name }}</span>
                </div>
              </td>
              <td class="py-4 px-4 text-gray-700">{{ medicine.quantity }}</td>
              <td class="py-4 px-4 text-gray-700">{{ medicine.dose }}</td>
              <td class="py-4 px-4 text-gray-700">{{ medicine.frequency }}</td>
              <td class="py-4 px-4">
                <span class="px-2 py-1 bg-green-100 text-green-700 text-sm rounded-full">
                  {{ medicine.administration }}
                </span>
              </td>
              <td class="py-4 px-4 text-gray-700">{{ medicine.duration }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Resumen de medicamentos a dispensar -->
  <div *ngIf="medicines.length > 0" class="bg-white rounded-lg shadow-lg border border-green-100">
    <div class="p-4 lg:p-6 bg-gradient-to-r from-green-50 to-transparent border-b border-green-100">
      <div class="flex items-center space-x-3">
        <div class="p-2 bg-green-100 rounded-lg">
          <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Resumen de Dispensación</h3>
          <p class="text-sm text-gray-600">Vista rápida de los medicamentos a entregar</p>
        </div>
      </div>
    </div>

    <div class="p-4 lg:p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div *ngFor="let medicine of medicines"
          class="flex items-start gap-3 p-4 bg-gradient-to-br from-blue-50 to-white rounded-xl border border-blue-100 hover:shadow-md transition-all duration-200">
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center flex-shrink-0">
            <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
            </svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="font-semibold text-gray-900">{{ medicine.name }}</p>
            <p class="text-sm text-gray-600">{{ medicine.dose }} • {{ medicine.frequency }}</p>
            <p class="text-xs text-gray-500 mt-1">Duración: {{ medicine.duration }}</p>
            <span
              class="inline-block mt-2 px-2 py-1 bg-green-50 text-green-700 text-xs rounded-full border border-green-200">
              {{ medicine.administration }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de acción finales -->
  <div class="bg-white rounded-lg shadow-lg border border-gray-200">
    <div class="p-4 lg:p-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
            </svg>
            <span class="text-sm text-gray-600">Verifique el stock antes de completar la dispensación</span>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button (click)="cancelDispensation()"
            class="flex items-center px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
            Cancelar
          </button>
          <button (click)="saveDraft()"
            class="flex items-center px-4 py-2 text-white bg-gray-600 rounded-lg hover:bg-gray-700 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
            </svg>
            Guardar Borrador
          </button>
          <button (click)="completeDispensation()" [disabled]="medicines.length === 0"
            class="flex items-center px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
            </svg>
            Completar Dispensación
          </button>
        </div>
      </div>
    </div>
  </div>
  </div> <!-- Cierre del paso 2 -->
</div>

<!-- Modal lateral derecho para agregar/editar medicamento -->
<div 
  *ngIf="showMedicineModal"
  class="fixed inset-0 z-50 overflow-hidden"
  (click)="closeMedicineModal()"
>
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black bg-opacity-50"></div>
  
  <!-- Panel lateral -->
  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl transform transition-transform duration-300 ease-in-out flex flex-col"
       (click)="$event.stopPropagation()">
    <!-- Header del modal -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 text-white flex-shrink-0">
      <div class="flex items-center justify-between">
        <div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <h2 class="text-lg font-semibold">{{ isEditMode ? 'Editar Medicamento' : 'Agregar Medicamento' }}</h2>
          </div>
          <p class="text-blue-100 text-sm mt-1">
            {{ isEditMode ? 'Modifica la información del medicamento' : 'Complete la información del medicamento a dispensar' }}
          </p>
        </div>
        <button 
          (click)="closeMedicineModal()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Contenido del modal con scroll -->
    <div class="flex-1 overflow-y-auto">
      <form (ngSubmit)="saveMedicine()" #medicineForm="ngForm" class="p-6 space-y-4">
      <!-- Medicamento -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Medicamento</label>
        <input type="text" [(ngModel)]="currentMedicine.name" name="name" required placeholder="Ibuprofeno"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Cantidad -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad</label>
        <input type="text" [(ngModel)]="currentMedicine.quantity" name="quantity" required placeholder="15 tabletas"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Dosis -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Dosis</label>
        <input type="text" [(ngModel)]="currentMedicine.dose" name="dose" required placeholder="400 mg"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Frecuencia -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Frecuencia</label>
        <select [(ngModel)]="currentMedicine.frequency" name="frequency" required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">Seleccione la frecuencia</option>
          <option value="1 vez al día">1 vez al día</option>
          <option value="2 veces al día">2 veces al día</option>
          <option value="3 veces al día">3 veces al día</option>
          <option value="4 veces al día">4 veces al día</option>
          <option value="Cada 8 horas">Cada 8 horas</option>
          <option value="Cada 12 horas">Cada 12 horas</option>
        </select>
      </div>

      <!-- Vía de Administración -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Vía de Administración</label>
        <select [(ngModel)]="currentMedicine.administration" name="administration" required
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="">Seleccione la vía</option>
          <option value="Oral">Oral</option>
          <option value="Tópica">Tópica</option>
          <option value="Intravenosa">Intravenosa</option>
          <option value="Intramuscular">Intramuscular</option>
          <option value="Subcutánea">Subcutánea</option>
        </select>
      </div>

      <!-- Duración -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Duración</label>
        <input type="text" [(ngModel)]="currentMedicine.duration" name="duration" required placeholder="5 días"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Observaciones -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Observaciones</label>
        <textarea [(ngModel)]="currentMedicine.observations" name="observations" rows="3"
          placeholder="Observaciones adicionales..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-3 pt-6 border-t border-gray-200 mt-6">
        <button *ngIf="isEditMode" 
                type="button" 
                (click)="deleteMedicine()"
                class="flex items-center gap-2 h-11 px-6 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
          </svg>
          Eliminar
        </button>
        <button type="button" 
                (click)="closeMedicineModal()"
                class="flex items-center gap-2 h-11 px-6 border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 rounded-lg font-medium transition-all">
          Cancelar
        </button>
        <button type="submit" 
                [disabled]="!medicineForm.form.valid"
                class="flex items-center gap-2 h-11 px-6 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg font-medium transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
          </svg>
          {{ isEditMode ? 'Editar' : 'Agregar' }}
        </button>
      </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal de sugerencia de rol -->
<app-role-suggestion-modal
  [isOpen]="showRoleSuggestionModal()"
  (dismiss)="onRoleSuggestionDismiss()"
  (roleChanged)="onRoleChanged()"
></app-role-suggestion-modal>